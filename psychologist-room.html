<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Psychologist Room - Detective AI</title>
  <style>
    body {
      background: #121212;
      color: #eee;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 0;
      min-height: 100vh;
      display: flex; justify-content: center; align-items: flex-start;
    }
    #login-container, #room-content {
      background: #1e1e1e;
      padding: 25px 30px;
      border-radius: 12px;
      box-shadow: 0 0 20px #3f51b5;
      max-width: 900px;
      width: 90%;
      margin: 50px 0;
    }
    #room-content { display: none; }
    h1 {
      color: #3f51b5;
      margin-bottom: 25px;
    }
    button {
      background: #3f51b5;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 0.9rem;
      color: #fff;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-left: 8px;
    }
    button:hover {
      background: #5c6bc0;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: 600;
    }
    input[type=text], input[type=number], input[type=password], select, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      background: #292929;
      border: none;
      border-radius: 8px;
      color: #eee;
      font-size: 1rem;
      box-sizing: border-box;
      resize: vertical;
    }
    textarea {
      min-height: 80px;
    }
    .report {
      background: #292929;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 25px;
      max-height: 520px;
      overflow-y: auto;
    }
    .report h3 {
      margin-top: 0;
      color: #81a6ff;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
    }
    .report h3 > span {
      flex: 1;
    }
    .status {
      margin-top: 10px;
      font-weight: 600;
    }
    .saved-notes {
      margin-top: 15px;
      background: #222;
      border-radius: 8px;
      padding: 10px;
      max-height: 140px;
      overflow-y: auto;
      font-size: 0.9rem;
    }
    .note-item {
      border-bottom: 1px solid #444;
      padding: 6px 0;
    }
    .note-item:last-child {
      border-bottom: none;
    }
    .wiki-summary {
      background: #101a2a;
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
      font-size: 0.9rem;
      max-height: 120px;
      overflow-y: auto;
      color: #add8e6;
      font-style: italic;
    }
  </style>
</head>
<body>

  <div id="login-container">
    <h2>üîê Psychologist Access</h2>
    <p>Enter password to access Psychologist Room.</p>
    <form id="login-form">
      <input type="password" id="pwd-input" placeholder="Password" required autofocus />
      <button type="submit">Enter</button>
    </form>
  </div>

  <div id="room-content">
    <h1>üß† Psychologist Room</h1>
    <div id="reports-container">
      <!-- Reports will appear here -->
    </div>
  </div>

  <script>
    const correctPassword = 'psychologist2025';

    document.getElementById('login-form').addEventListener('submit', function (e) {
      e.preventDefault();
      const input = document.getElementById('pwd-input').value;
      if (input === correctPassword) {
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('room-content').style.display = 'block';
        loadReports();
      } else {
        alert('Incorrect password! Access denied.');
      }
    });

    function loadReports() {
      const container = document.getElementById('reports-container');
      let reports = JSON.parse(localStorage.getItem('clientReports') || '[]');
      if (reports.length === 0) {
        container.innerHTML = '<p>No client reports available.</p>';
        return;
      }

      container.innerHTML = '';
      reports.forEach((report, idx) => {
        let psychData = JSON.parse(localStorage.getItem('psychologistData') || '{}');
        let saved = psychData[idx] || {};

        const nameEsc = escapeHtml(report.name);
        const ageEsc = escapeHtml(report.age);
        const genderEsc = escapeHtml(report.gender);
        const whenEsc = escapeHtml(report.when);
        const behaviorEsc = escapeHtml(report.behavior);
        const messageEsc = escapeHtml(report.message);

        let behaviorKeywords = report.behavior ? report.behavior.split(/[,;.]/)[0].trim() : '';
        let scholarSearchURL = `https://scholar.google.com/scholar?q=${encodeURIComponent(behaviorKeywords)}`;
        let facebookSearchURL = `https://www.facebook.com/search/top?q=${encodeURIComponent(report.name)}`;
        let whenParts = report.when.split(' - ');
        let datePart = whenParts[0]?.trim() || '';
        let locationPart = whenParts[1]?.trim() || '';
        let weatherSearchQuery = `${datePart} weather in ${locationPart}`.trim();
        let weatherSearchURL = `https://www.google.com/search?q=${encodeURIComponent(weatherSearchQuery)}`;

        const wikiSummaryId = `wiki-summary-${idx}`;
        const div = document.createElement('div');
        div.className = 'report';
        div.innerHTML = `
          <h3><span>Report #${idx + 1} - ${nameEsc}</span>
            <button onclick="window.open('${facebookSearchURL}', '_blank')">üîç Facebook</button>
          </h3>
          <b>Age:</b> ${ageEsc}<br>
          <b>Gender:</b> ${genderEsc}<br>
          <b>When:</b> ${whenEsc}
          <button onclick="window.open('${weatherSearchURL}', '_blank')">üå§Ô∏è Weather</button><br>
          <b>Behavior:</b> ${behaviorEsc}
          <button onclick="window.open('${scholarSearchURL}', '_blank')">üìö Scholar</button>

          <div class="wiki-summary" id="${wikiSummaryId}">
            <em>Loading Wikipedia summary for behavior...</em>
          </div>

          <label>Psychologist Observations / Experience:</label>
          <textarea id="obs-${idx}" placeholder="Write your observations...">${saved.observations || ''}</textarea>

          <label>Behavior Details (age/gender/experience):</label>
          <input type="text" id="behav-details-${idx}" value="${saved.behaviorDetails || ''}" />

          <label>Psychological Notes:</label>
          <textarea id="notes-${idx}" placeholder="Add psychological notes...">${saved.notes || ''}</textarea>

          <button onclick="saveData(${idx})">Save Psychologist Data</button>
          <div class="status" id="status-${idx}"></div>

          <div class="saved-notes" id="saved-notes-${idx}">
            ${renderSavedNotes(saved.savedNotes || [])}
          </div>
        `;
        container.appendChild(div);
        fetchWikipediaSummary(behaviorKeywords, wikiSummaryId);
      });
    }

    function saveData(idx) {
      const obs = document.getElementById(`obs-${idx}`).value.trim();
      const behav = document.getElementById(`behav-details-${idx}`).value.trim();
      const notes = document.getElementById(`notes-${idx}`).value.trim();
      const status = document.getElementById(`status-${idx}`);

      let psychData = JSON.parse(localStorage.getItem('psychologistData') || '{}');
      if (!psychData[idx]) psychData[idx] = { savedNotes: [] };

      psychData[idx].observations = obs;
      psychData[idx].behaviorDetails = behav;
      psychData[idx].notes = notes;
      const now = new Date().toLocaleString();
      psychData[idx].savedNotes.push(`[${now}] Observations saved.`);

      localStorage.setItem('psychologistData', JSON.stringify(psychData));

      status.style.color = '#4caf50';
      status.textContent = 'Data saved successfully.';
      renderSavedNotesUI(idx, psychData[idx].savedNotes);
    }

    function renderSavedNotes(notesArr) {
      if (!notesArr.length) return '<em>No saved notes yet.</em>';
      return notesArr.map(n => `<div class="note-item">${escapeHtml(n)}</div>`).join('');
    }

    function renderSavedNotesUI(idx, notesArr) {
      document.getElementById(`saved-notes-${idx}`).innerHTML = renderSavedNotes(notesArr);
    }

    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m]);
    }

    async function fetchWikipediaSummary(query, containerId) {
      if (!query) {
        document.getElementById(containerId).innerHTML = "<em>No behavior keywords provided.</em>";
        return;
      }
      try {
        const resp = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`);
        if (!resp.ok) throw new Error();
        const data = await resp.json();
        document.getElementById(containerId).innerHTML = data.extract
          ? `<strong>Wikipedia summary:</strong> ${escapeHtml(data.extract)}`
          : "<em>No summary available for this topic.</em>";
      } catch {
        document.getElementById(containerId).innerHTML = "<em>Wikipedia summary not found.</em>";
      }
    }
  </script>

</body>
</html>
