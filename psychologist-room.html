<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Psychologist Room - Detective AI</title>
  <style>
    body {
      background: #121212;
      color: #eee;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 0;
      min-height: 100vh;
      display: flex; justify-content: center; align-items: flex-start;
    }

    #login-container, #room-content {
      background: #1e1e1e;
      padding: 25px 30px;
      border-radius: 12px;
      box-shadow: 0 0 20px #3f51b5;
      max-width: 900px;
      width: 90%;
      margin: 50px 0;
    }

    #room-content { display: none; }

    h1 {
      color: #3f51b5;
      margin-bottom: 25px;
    }

    button {
      background: #3f51b5;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 0.9rem;
      color: #fff;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-left: 8px;
    }

    button:hover {
      background: #5c6bc0;
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: 600;
    }

    input[type=text], input[type=number], input[type=password], select, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      background: #292929;
      border: none;
      border-radius: 8px;
      color: #eee;
      font-size: 1rem;
      box-sizing: border-box;
      resize: vertical;
    }

    textarea {
      min-height: 80px;
    }

    .report {
      background: #292929;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 25px;
      box-shadow: 0 0 8px rgba(63, 81, 181, 0.4);
    }

    .report h3 {
      margin-top: 0;
      color: #81a6ff;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
    }

    .report h3 > span {
      flex: 1;
    }

    .status {
      margin-top: 10px;
      font-weight: 600;
      color: #4caf50;
    }

    .saved-notes {
      margin-top: 15px;
      background: #222;
      border-radius: 8px;
      padding: 10px;
      max-height: 140px;
      overflow-y: auto;
      font-size: 0.9rem;
    }

    .note-item {
      border-bottom: 1px solid #444;
      padding: 6px 0;
    }

    .note-item:last-child {
      border-bottom: none;
    }

    /* üß† Elfsight Widget (initially hidden) */
    .elfsight-app-38d8b2d9-12fc-48f3-a677-75ba1f2d5c0b {
      display: none;
    }

    .chat-visible .elfsight-app-38d8b2d9-12fc-48f3-a677-75ba1f2d5c0b {
      display: block;
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
    }
  </style>
</head>
<body>

  <div id="login-container">
    <h2>üîê Psychologist Access</h2>
    <p>Enter password to access Psychologist Room.</p>
    <form id="login-form">
      <input type="password" id="pwd-input" placeholder="Password" required autofocus />
      <button type="submit">Enter</button>
    </form>
  </div>

  <div id="room-content">
    <h1>üß† Psychologist Room</h1>
    <div id="reports-container">
      <!-- Reports will appear here -->
    </div>
  </div>

  <!-- ‚úÖ Elfsight AI Chatbot Script -->
  <script src="https://elfsightcdn.com/platform.js" async></script>
  <div class="elfsight-app-38d8b2d9-12fc-48f3-a677-75ba1f2d5c0b" data-elfsight-app-lazy></div>

  <script>
    const correctPassword = 'psychologist2025';

    document.getElementById('login-form').addEventListener('submit', function (e) {
      e.preventDefault();
      const input = document.getElementById('pwd-input').value;
      if (input === correctPassword) {
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('room-content').style.display = 'block';
        document.body.classList.add('chat-visible'); // Show chatbot
        loadReports();
      } else {
        alert('Incorrect password! Access denied.');
      }
    });

    function loadReports() {
      const container = document.getElementById('reports-container');
      let reports = JSON.parse(localStorage.getItem('clientReports') || '[]');
      if (reports.length === 0) {
        container.innerHTML = '<p>No client reports available.</p>';
        return;
      }

      container.innerHTML = '';
      reports.forEach((report, idx) => {
        let psychData = JSON.parse(localStorage.getItem('psychologistData') || '{}');
        let saved = psychData[idx] || {};

        const nameEsc = escapeHtml(report.name || '');
        const ageEsc = escapeHtml(report.age || '');
        const genderEsc = escapeHtml(report.gender || '');
        const whenStr = typeof report.when === 'string' ? report.when : '';
        const behaviorStr = typeof report.behavior === 'string' ? report.behavior : '';
        const messageEsc = escapeHtml(report.message || '');

        // Safe split on when for google search
        let whenParts = whenStr.length > 0 ? whenStr.split(' - ') : ['', ''];
        let datePart = whenParts[0]?.trim() || '';
        let locationPart = whenParts[1]?.trim() || '';
        let weatherSearchQuery = `what ${datePart} weather in ${locationPart}`.trim();

        // URLs for buttons
        let facebookSearchURL = `https://www.facebook.com/search/top?q=${encodeURIComponent(report.name || '')}`;
        let weatherSearchURL = `https://www.google.com/search?q=${encodeURIComponent(weatherSearchQuery)}`;

        const div = document.createElement('div');
        div.className = 'report';
        div.innerHTML = `
          <h3>
            <span>Report #${idx + 1} - ${nameEsc}</span>
            <button onclick="window.open('${facebookSearchURL}', '_blank')">üîç Facebook</button>
            <button onclick="window.open('${weatherSearchURL}', '_blank')">üå§Ô∏è Weather</button>
          </h3>
          <b>Age:</b> ${ageEsc}<br>
          <b>Gender:</b> ${genderEsc}<br>
          <b>When:</b> ${whenStr}<br>
          <b>Behavior:</b> ${behaviorStr}<br>
          <b>Message:</b> ${messageEsc}<br>

          <label>Psychologist Observations:</label>
          <textarea id="obs-${idx}" placeholder="Write your observations...">${saved.observations || ''}</textarea>

          <label>Behavior Details:</label>
          <input type="text" id="behav-details-${idx}" value="${saved.behaviorDetails || ''}" />

          <label>Psychological Notes:</label>
          <textarea id="notes-${idx}" placeholder="Add psychological notes...">${saved.notes || ''}</textarea>

          <button onclick="saveData(${idx})">üíæ Save</button>
          <button onclick="sendToChatbot('${nameEsc}', document.getElementById('behav-details-${idx}').value, document.getElementById('notes-${idx}').value)">ü§ñ Send to Chatbot</button>

          <div class="status" id="status-${idx}"></div>

          <div class="saved-notes" id="saved-notes-${idx}">
            ${renderSavedNotes(saved.savedNotes || [])}
          </div>
        `;
        container.appendChild(div);

        // Auto-send original behavior and message to chatbot immediately on load
        sendToChatbot(nameEsc, behaviorStr, messageEsc);
      });
    }

    function saveData(idx) {
      const obs = document.getElementById(`obs-${idx}`).value.trim();
      const behav = document.getElementById(`behav-details-${idx}`).value.trim();
      const notes = document.getElementById(`notes-${idx}`).value.trim();
      const status = document.getElementById(`status-${idx}`);

      let psychData = JSON.parse(localStorage.getItem('psychologistData') || '{}');
      if (!psychData[idx]) psychData[idx] = { savedNotes: [] };

      psychData[idx].observations = obs;
      psychData[idx].behaviorDetails = behav;
      psychData[idx].notes = notes;
      const now = new Date().toLocaleString();
      psychData[idx].savedNotes.push(`[${now}] Observations saved.`);

      localStorage.setItem('psychologistData', JSON.stringify(psychData));

      status.textContent = 'Data saved successfully.';
      renderSavedNotesUI(idx, psychData[idx].savedNotes);
    }

    function sendToChatbot(name, behavior, message) {
      const msg = `Client: ${name}\nBehavior: ${behavior}\nMessage: ${message}`;
      if (window.ElfsightMessengerAPI) {
        window.ElfsightMessengerAPI.send(msg);
      } else {
        // Fallback: alert or console log
        console.warn('Chatbot API not ready. Try again in a moment.');
      }
    }

    function renderSavedNotes(notesArr) {
      if (!notesArr.length) return '<em>No saved notes yet.</em>';
      return notesArr.map(n => `<div class="note-item">${escapeHtml(n)}</div>`).join('');
    }

    function renderSavedNotesUI(idx, notesArr) {
      document.getElementById(`saved-notes-${idx}`).innerHTML = renderSavedNotes(notesArr);
    }

    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m]);
    }
  </script>
</body>
</html>
